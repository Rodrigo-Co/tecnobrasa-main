<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word</title>
  <link rel="stylesheet" href="/pagvideos.css">
  <link rel="stylesheet" href="/pagaluno.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
</head>

<body>
  <div id="sidebar" class="sidebar">
    <!-- Conteúdo da barra lateral -->
    
    <div id="infouser">
        <div id="imguser">
          <img src="../uploads/default-profile.png" id="imguserelement"> <!-- Coloque uma imagem padrão -->
        </div>
        <h2 id="nomeusuario">Usuario</h2>
    </div>

    <div id="linha">
    </div>
    <ul>
        <li><a href="/pagaluno.html">Cursos</a></li>
        <li><a href="https://www.mapadaprova.com.br/questoes/informatica-basica/office-365"
                target="_blank">Questões</a></li>
        <li><a href="/config.html">Configurações</a></li>

        <li><a href="/indexInicio.html">Sair</a></li>
    </ul>
    <div id="linha2">

        <h2>TECNOBRASA</h2>
    </div>
</div>

  <div id="content">
    <div id="boxmenu">
      <img src="/barras.png" id="menu-toggle">
      <h2>Meus Cursos</h2>
    </div>

    <!-- Barra de Progresso -->
<div class="progress" role="progressbar" aria-label="Progresso" aria-valuemin="0" aria-valuemax="100">
  <div class="progress-bar text-bg-warning" style="width: 0%;" id="progress-bar">0%</div>
</div>

    <!-- Container principal com Flexbox -->
    <div id="video-container" class="d-flex">
      <!-- Lista de vídeos -->
      <div id="Container" class="container-fluid" style="flex: 1;">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action" aria-current="true" onclick="openVideo('https://www.youtube.com/embed/88MRrNI0u_4', 'Word Office Básico')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Básico" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Básico</h5>
                  <small>10 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para iniciantes.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('https://www.youtube.com/embed/kbJRDVxArUc', 'Word Office Intermediário')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Intermediário" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Intermediário</h5>
                  <small>20 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para aprofundamento no Word.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('https://www.youtube.com/embed/l1FY4o_Ijm8', 'Word Office Avançado')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Avançado" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Avançado</h5>
                  <small>30 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para revisão geral.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Vídeo e Área de Notas -->
      <div id="videoPlayerSection" style="flex: 2; margin-left: 10px; margin-top: -65px;">
        <button onclick="closeVideo()">Fechar</button>
        <div style="display: flex; flex-direction: column; align-items: flex-start;">
          <div id="videoPlayer" style="width: 800px; height: 600px;" ></div>
          <div style="margin-top: 20px; width: 100%;">
            <center><h3 id="videoTitle">Título do Vídeo</h3></center>
            <textarea id="videoNotes" rows="8" cols="50" placeholder="Escreva suas anotações aqui..." style="width: 100%; margin-top: 10px;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
  <script src='https://cdn.jsdelivr.net/jquery.mixitup/latest/jquery.mixitup.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let youtubePlayer; // Variável global para o player do YouTube

// Função para abrir o vídeo
function openVideo(videoSrc, title) {
  // Atualizar o título do vídeo
  document.getElementById('videoTitle').innerText = title;

  if (videoSrc.includes('youtube.com')) {
    // Caso seja um vídeo do YouTube
    const videoId = videoSrc.split('/embed/')[1]; // Pegar o ID do vídeo do YouTube
    loadYouTubePlayer(videoId);
  } else {
    // Caso seja um vídeo local
    const videoPlayer = document.getElementById('videoPlayer');
    videoPlayer.innerHTML = `<iframe src="${videoSrc}" width="800" height="600" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
  }

  // Mostrar a seção de vídeo
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.classList.remove('d-none');
  videoSection.style.display = 'flex';
}

// Função para carregar o player do YouTube
function loadYouTubePlayer(videoId) {
  if (!youtubePlayer) {
    // Criar o player se ainda não foi criado
    youtubePlayer = new YT.Player('videoPlayer', {
      height: '600',
      width: '800',
      videoId: videoId,
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  } else {
    // Se o player já existe, carregue um novo vídeo
    youtubePlayer.loadVideoById(videoId);
  }
}

// Verifica se o vídeo do YouTube terminou
function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    const videoIdAtual = youtubePlayer.getVideoUrl();

    let videosAssistidosIds = JSON.parse(localStorage.getItem('videosAssistidosIds')) || [];

    if (!videosAssistidosIds.includes(videoIdAtual)) {
      videosAssistidosIds.push(videoIdAtual);
      localStorage.setItem('videosAssistidosIds', JSON.stringify(videosAssistidosIds));
      salvarProgresso(videosAssistidosIds.length, 3);
    }
  }
}

function closeVideo() {
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.style.display = 'none';

  if (youtubePlayer) {
    youtubePlayer.stopVideo(); // Parar o vídeo do YouTube
  }
}
  
    // Ativar/desativar o menu lateral
    $('#menu-toggle').on('click', function () {
      $('#sidebar').toggleClass('active');
      $('#content').toggleClass('shifted');
    });
  
    // Quando o documento estiver pronto, faça a requisição para obter os dados do usuário logado
    $(document).ready(function() {
        $.ajax({
            url: '/user/profile', // URL da rota no backend
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Atualiza o nome do usuário
                    $('#nomeusuario').text(response.nome);

                    // Atualiza a imagem do usuário
                    $('#imguserelement').attr('src', response.profileImage);
                } else {
                    console.error('Erro ao carregar informações do usuário:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro na requisição:', error);
            }
        });
    });
    let usuarioId; // Declarar uma variável global para armazenar o usuarioId
    // Fazer a requisição para buscar o ID do usuário
function obterUsuarioId() {
    return $.ajax({
        url: '/getUsuarioId',
        method: 'GET',
        success: function(response) {
            if (response.usuarioId) {
                usuarioId = response.usuarioId; // Armazenar o ID do usuário na variável global
                //console.log('ID do usuário:', usuarioId);  Para verificar se o ID foi obtido
            }
        },
        error: function(xhr, status, error) {
            console.error('Erro ao buscar ID do usuário:', error);
        }
    });
}
    // Ouvir quando o vídeo terminar
    document.getElementById('videoPlayer').addEventListener('ended', function() {
    const videoIdAtual = document.getElementById('videoPlayer').getAttribute('src'); // Obter o ID do vídeo atual (ou a URL, se usar isso como identificador)

    // Obtenha a lista de vídeos assistidos do localStorage (ou crie uma nova lista vazia)
    let videosAssistidosIds = JSON.parse(localStorage.getItem('videosAssistidosIds')) || [];

    // Verifique se o vídeo atual já foi assistido
    if (!videosAssistidosIds.includes(videoIdAtual)) {
        // Se não foi assistido ainda, adicione o ID à lista
        videosAssistidosIds.push(videoIdAtual);

        // Atualize o localStorage com a lista de vídeos assistidos
        localStorage.setItem('videosAssistidosIds', JSON.stringify(videosAssistidosIds));

        // Atualize o progresso normalmente
        let videosAssistidos = videosAssistidosIds.length; // Agora é o tamanho da lista de IDs
        const totalVideos = 3; // Exemplo com 3 vídeos

        // Chame a função para salvar o progresso
        salvarProgresso(videosAssistidos, totalVideos);
    } else {
        console.log('Este vídeo já foi assistido. Progresso não será incrementado.');
    }
});
function salvarProgresso(videosAssistidos, totalVideos) {
  if (!usuarioId) {
        console.error('ID do usuário não foi obtido ainda!');
        return;
    }

    const cursoId = 1; // O ID do curso (também pode ser dinâmico)

    const data = {
        usuarioId: usuarioId,
        cursoId: cursoId,
        videosAssistidos: videosAssistidos,
        totalVideos: totalVideos
    };

    // Fazer a requisição POST para salvar o progresso
    $.ajax({
        url: '/salvarProgresso',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            //alert(response.message); // Exibe uma mensagem de sucesso
            atualizarBarraProgresso(Math.min((videosAssistidos / totalVideos) * 100, 100)); // Atualiza a barra de progresso
        },
        error: function(xhr, status, error) {
            console.error('Erro ao salvar progresso:', error);
        }
    });
}
function atualizarBarraProgresso(progresso) {
  const progressBar = document.getElementById('progress-bar'); // Usa o ID em vez da classe
  const progressoLimitado = Math.min(progresso, 100); // Limita o progresso a 100%
  progressBar.style.width = `${progresso}%`; // Define a largura em porcentagem
  progressBar.innerText = `${progresso.toFixed(0)}%`; // Atualiza o texto da barra
}

// Chamar a função de obtenção do ID do usuário assim que a página carregar
$(document).ready(function() {
    // Primeiro obtenha o ID do usuário
    obterUsuarioId().then(function() {
        // Fazer requisição para buscar o progresso do curso
        $.ajax({
            url: '/getProgresso',
            method: 'GET',
            data: { usuarioId: usuarioId, cursoId: 1 },
            success: function(response) {
                const progresso = Math.min((response.videosAssistidos / 3) * 100, 100); // Exemplo com 3 vídeos
                atualizarBarraProgresso(progresso); // Atualiza a barra de progresso
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar progresso:', error);
            }
        });
    });
});

  </script>
</body>

</html>
