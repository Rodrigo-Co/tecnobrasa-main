<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word</title>
  <link rel="stylesheet" href="/pagvideos.css">
  <link rel="stylesheet" href="/pagaluno.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
</head>

<body>
  <div id="sidebar" class="sidebar">
    <!-- Conteúdo da barra lateral -->
    
    <div id="infouser">
        <div id="imguser">
          <img src="../uploads/default-profile.png" id="imguserelement"> <!-- Coloque uma imagem padrão -->
        </div>
        <h2 id="nomeusuario">Usuario</h2>
    </div>

    <div id="linha">
    </div>
    <ul>
        <li><a href="/pagaluno.html">Cursos</a></li>
        <li><a href="https://www.mapadaprova.com.br/questoes/informatica-basica/office-365"
                target="_blank">Questões</a></li>
        <li><a href="/config.html">Configurações</a></li>

        <li><a href="/indexInicio.html">Sair</a></li>
    </ul>
    <div id="linha2">

        <h2>TECNOBRASA</h2>
    </div>
</div>

  <div id="content">
    <div id="boxmenu">
      <img src="/barras.png" id="menu-toggle">
      <h2>Meus Cursos</h2>
    </div>

    <!-- Barra de Progresso -->
<div class="progress" role="progressbar" aria-label="Progresso" aria-valuemin="0" aria-valuemax="100">
  <div class="progress-bar text-bg-warning" style="width: 0%;" id="progress-bar">0%</div>
</div>

    <!-- Container principal com Flexbox -->
    <div id="video-container" class="d-flex">
      <!-- Lista de vídeos -->
      <div id="Container" class="container-fluid" style="flex: 1;">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action" aria-current="true" onclick="openVideo('1', 'Word Office Básico')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Básico" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Básico</h5>
                  <small>10 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para iniciantes.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('2', 'Word Office Intermediário')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Intermediário" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Intermediário</h5>
                  <small>10 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para aprofundamento no Word.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('3', 'Word Office Avançado')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Avançado" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Avançado</h5>
                  <small>30 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para revisão geral.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Vídeo e Área de Notas -->
      <div id="videoPlayerSection" style="flex: 2; margin-left: 10px; margin-top: -65px;">
        <button onclick="closeVideo()">Fechar</button>
        <div style="display: flex; flex-direction: column; align-items: flex-start;">
          <video id="videoPlayer" width="800" height="600" controls>
            <source src="" type="video/mp4">
            Seu navegador não suporta o elemento de vídeo.
          </video>
          <div style="margin-top: 20px; width: 100%;">
            <center><h3 id="videoTitle">Título do Vídeo</h3></center>
            <textarea id="videoNotes" rows="8" cols="50" placeholder="Escreva suas anotações aqui..." style="width: 100%; margin-top: 10px;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
  <script src='https://cdn.jsdelivr.net/jquery.mixitup/latest/jquery.mixitup.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openVideo(videoId, title) {
  // Atualizar o título do vídeo
  document.getElementById('videoTitle').innerText = title;

  // Definir a URL do vídeo com base no ID do vídeo (ou outra lógica)
  const videoSrc = `/video/video-test.mp4`; // Exemplo de nome de vídeo
  const videoPlayer = document.getElementById('videoPlayer');
  videoPlayer.src = videoSrc;

  // Mostrar a seção de vídeo e remover a classe 'd-none'
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.classList.remove('d-none');  // Remove 'd-none' para mostrar a seção
  videoSection.style.display = 'flex';      // Define flex para layout

  // Ajustar o tamanho da lista de vídeos
  document.getElementById('Container').style.flex = '1'; // Reduzir espaço da lista de vídeos
}

function closeVideo() {
  // Esconder o vídeo e restaurar o layout original
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.classList.add('d-none'); // Adiciona 'd-none' para esconder a seção
  videoSection.style.display = 'none';  // Esconde o player

  document.getElementById('Container').style.flex = '2'; // Restaurar o tamanho original da lista de vídeos
}
  
    // Ativar/desativar o menu lateral
    $('#menu-toggle').on('click', function () {
      $('#sidebar').toggleClass('active');
      $('#content').toggleClass('shifted');
    });
  
    // Quando o documento estiver pronto, faça a requisição para obter os dados do usuário logado
    $(document).ready(function() {
        $.ajax({
            url: '/user/profile', // URL da rota no backend
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Atualiza o nome do usuário
                    $('#nomeusuario').text(response.nome);

                    // Atualiza a imagem do usuário
                    $('#imguserelement').attr('src', response.profileImage);
                } else {
                    console.error('Erro ao carregar informações do usuário:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro na requisição:', error);
            }
        });
    });
    let usuarioId; // Declarar uma variável global para armazenar o usuarioId
    // Fazer a requisição para buscar o ID do usuário
function obterUsuarioId() {
    return $.ajax({
        url: '/getUsuarioId',
        method: 'GET',
        success: function(response) {
            if (response.usuarioId) {
                usuarioId = response.usuarioId; // Armazenar o ID do usuário na variável global
                //console.log('ID do usuário:', usuarioId);  Para verificar se o ID foi obtido
            }
        },
        error: function(xhr, status, error) {
            console.error('Erro ao buscar ID do usuário:', error);
        }
    });
}
    // Ouvir quando o vídeo terminar
document.getElementById('videoPlayer').addEventListener('ended', function() {
    // Incrementar o número de vídeos assistidos
    let videosAssistidos = parseInt(localStorage.getItem('videosAssistidos')) || 0;
    // Total de vídeos no curso (pode ser dinâmico)
    const totalVideos = 3; // Exemplo com 3 vídeos
    if (videosAssistidos < totalVideos) {
        videosAssistidos += 1;
    }
    localStorage.setItem('videosAssistidos', videosAssistidos);


    // Chamar a função para salvar o progresso
    salvarProgresso(videosAssistidos, totalVideos);
});
function salvarProgresso(videosAssistidos, totalVideos) {
  if (!usuarioId) {
        console.error('ID do usuário não foi obtido ainda!');
        return;
    }

    const cursoId = 1; // O ID do curso (também pode ser dinâmico)

    const data = {
        usuarioId: usuarioId,
        cursoId: cursoId,
        videosAssistidos: videosAssistidos,
        totalVideos: totalVideos
    };

    // Fazer a requisição POST para salvar o progresso
    $.ajax({
        url: '/salvarProgresso',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            alert(response.message); // Exibe uma mensagem de sucesso
            atualizarBarraProgresso(Math.min((videosAssistidos / totalVideos) * 100, 100)); // Atualiza a barra de progresso
        },
        error: function(xhr, status, error) {
            console.error('Erro ao salvar progresso:', error);
        }
    });
}
function atualizarBarraProgresso(progresso) {
  const progressBar = document.getElementById('progress-bar'); // Usa o ID em vez da classe
  const progressoLimitado = Math.min(progresso, 100); // Limita o progresso a 100%
  progressBar.style.width = `${progresso}%`; // Define a largura em porcentagem
  progressBar.innerText = `${progresso.toFixed(0)}%`; // Atualiza o texto da barra
}

// Chamar a função de obtenção do ID do usuário assim que a página carregar
$(document).ready(function() {
    // Primeiro obtenha o ID do usuário
    obterUsuarioId().then(function() {
        // Fazer requisição para buscar o progresso do curso
        $.ajax({
            url: '/getProgresso',
            method: 'GET',
            data: { usuarioId: usuarioId, cursoId: 1 },
            success: function(response) {
                const progresso = Math.min((response.videosAssistidos / 3) * 100, 100); // Exemplo com 3 vídeos
                atualizarBarraProgresso(progresso); // Atualiza a barra de progresso
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar progresso:', error);
            }
        });
    });
});

  </script>
</body>

</html>
