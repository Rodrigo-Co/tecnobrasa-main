<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word</title>
  <link rel="stylesheet" href="/pagvideos.css">
  <link rel="stylesheet" href="/pagaluno.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
</head>

<body>
  <div id="sidebar" class="sidebar">
    <!-- Conteúdo da barra lateral -->
    
    <div id="infouser">
        <div id="imguser">
          <img src="../uploads/default-profile.png" id="imguserelement"> <!-- Coloque uma imagem padrão -->
        </div>
        <h2 id="nomeusuario">Usuario</h2>
    </div>

    <div id="linha">
    </div>
    <ul>
        <li><a href="/pagaluno.html">Cursos</a></li>
        <li><a href="https://www.mapadaprova.com.br/questoes/informatica-basica/office-365"
                target="_blank">Questões</a></li>
        <li><a href="/config.html">Configurações</a></li>

        <li><a href="/indexInicio.html">Sair</a></li>
    </ul>
    <div id="linha2">

        <h2>TECNOBRASA</h2>
    </div>
</div>

  <div id="content">
    <div id="boxmenu">
      <img src="/barras.png" id="menu-toggle">
      <h2>Meus Cursos</h2>
    </div>

    <!-- Barra de Progresso -->
<div class="progress" role="progressbar" aria-label="Progresso" aria-valuemin="0" aria-valuemax="100">
  <div class="progress-bar text-bg-warning" style="width: 0%;" id="progress-bar">0%</div>
</div>

    <!-- Container principal com Flexbox -->
    <div id="video-container" class="d-flex">
      <!-- Lista de vídeos -->
      <div id="Container" class="container-fluid" style="flex: 1;">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action" aria-current="true" onclick="openVideo('https://www.youtube.com/embed/88MRrNI0u_4', 'Word Office Básico', 'video1')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Básico" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Básico</h5>
                  <small>10 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para iniciantes.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('https://www.youtube.com/embed/kbJRDVxArUc', 'Word Office Intermediário', 'video2')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Intermediário" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Intermediário</h5>
                  <small>20 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para aprofundamento no Word.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action" onclick="openVideo('https://www.youtube.com/embed/l1FY4o_Ijm8', 'Word Office Avançado', 'video3')">
            <div class="d-flex align-items-center">
              <div id="icon" style="margin-right: 15px;">
                <img src="/caioicon.jpg" alt="Word Avançado" style="width: 70px; height: 70px; border-radius: 50%;">
              </div>
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <h5 class="mb-1">Word Office Avançado</h5>
                  <small>30 minutos</small>
                </div>
                <p class="mb-1">Aula voltada para revisão geral.</p>
                <small style="position: relative; right: 0;">Caio Ribeiro</small>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Contêiner de Vídeo e Avaliação -->
<div id="videoAndRatingContainer" style="display: flex; flex-direction: row; margin-left: 50px; margin-top: 65px; margin-right: 100px;">
  
  <!-- Vídeo e Área de Notas -->
  <div id="videoPlayerSection" style="flex: 2;">
    
    <div style="display: flex; flex-direction: column; align-items: flex-start; height: 1100px;">
      <center><h3 id="videoTitle">Título do Vídeo</h3></center>
      <div id="videoPlayer" style="width: 1100px; height: 700px; background-color: black;"></div>
      <textarea id="videoNotes" rows="8" cols="50" placeholder="Escreva suas anotações aqui..." style="width: 100%; margin-top: 10px;"></textarea>
      
      <!-- Área de Avaliação de Estrelas -->
      <div id="ratingSection" style="flex: 1; margin-left: 90px; display: none; flex-direction: column;">
        <h3>Avalie o Vídeo:</h3>
        <div class="star-rating" style="display: flex; flex-direction: row; gap: 10px; align-items: center;">
          <span class="star" data-value="1">&#9733;</span>
          <span class="star" data-value="2">&#9733;</span>
          <span class="star" data-value="3">&#9733;</span>
          <span class="star" data-value="4">&#9733;</span>
          <span class="star" data-value="5">&#9733;</span>
        </div>
      </div>
    
      <center><button onclick="closeVideo()">FECHAR</button></center>
      <div style="margin-top: 20px; width: 100%;"></div>
    </div>
    

  
  </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
  <script src='https://cdn.jsdelivr.net/jquery.mixitup/latest/jquery.mixitup.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let youtubePlayer; // Variável global para o player do YouTube
let videosJaAssistidos = []; // Lista para armazenar os vídeos já assistidos


// Função para abrir o vídeo e contar progresso ao clicar
function openVideo(videoSrc, title, videoIdAtual) {
  // Atualizar o título do vídeo
  document.getElementById('videoTitle').innerText = title;

  if (videoSrc.includes('youtube.com')) {
    // Caso seja um vídeo do YouTube
    const videoId = videoSrc.split('/embed/')[1]; // Pegar o ID do vídeo do YouTube
    loadYouTubePlayer(videoId);
  } else {
    // Caso seja um vídeo local
    const videoPlayer = document.getElementById('videoPlayer');
    videoPlayer.innerHTML = `<iframe src="${videoSrc}" width="800" height="600" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
  }

  // Mostrar a seção de vídeo
  const ratingSection = document.getElementById('ratingSection');
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.style.display = 'flex';
  ratingSection.style.display = 'flex';

  // Chamar função para contar progresso ao clicar no item
  contarProgresso(videoIdAtual);
}

// Função para carregar o player do YouTube
function loadYouTubePlayer(videoId) {
  if (!youtubePlayer) {
    // Criar o player se ainda não foi criado
    youtubePlayer = new YT.Player('videoPlayer', {
      height: '600',
      width: '800',
      videoId: videoId,
    });
  } else {
    // Se o player já existe, carregue um novo vídeo
    youtubePlayer.loadVideoById(videoId);
    youtubePlayer.seekTo(0);
  }
}

// Verifica o estado do vídeo do YouTube
function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    const videoIdAtual = youtubePlayer.getVideoData().video_id; // Pegar o ID correto do vídeo

  }
}

function closeVideo() {
  const videoSection = document.getElementById('videoPlayerSection');
  videoSection.style.display = 'none';

  if (youtubePlayer) {
    youtubePlayer.stopVideo(); // Parar o vídeo do YouTube
  }
}
  
    // Ativar/desativar o menu lateral
    $('#menu-toggle').on('click', function () {
      $('#sidebar').toggleClass('active');
      $('#content').toggleClass('shifted');
    });
  
    // Quando o documento estiver pronto, faça a requisição para obter os dados do usuário logado
    $(document).ready(function() {
        $.ajax({
            url: '/user/profile', // URL da rota no backend
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Atualiza o nome do usuário
                    $('#nomeusuario').text(response.nome);

                    // Atualiza a imagem do usuário
                    $('#imguserelement').attr('src', response.profileImage);
                } else {
                    console.error('Erro ao carregar informações do usuário:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro na requisição:', error);
            }
        });
    });
    let usuarioId; // Declarar uma variável global para armazenar o usuarioId
    // Fazer a requisição para buscar o ID do usuário
function obterUsuarioId() {
    return $.ajax({
        url: '/getUsuarioId',
        method: 'GET',
        success: function(response) {
            if (response.usuarioId) {
                usuarioId = response.usuarioId; // Armazenar o ID do usuário na variável global
                //console.log('ID do usuário:', usuarioId);  Para verificar se o ID foi obtido
            }
        },
        error: function(xhr, status, error) {
            console.error('Erro ao buscar ID do usuário:', error);
        }
    });
}
// Função para contar progresso sem duplicar
function contarProgresso(videoIdAtual) {
  // Verifica se o ID do usuário está disponível
  if (!usuarioId) {
    console.error('ID do usuário não foi obtido ainda!');
    return;
  }

  // Busca no banco de dados se o vídeo já foi assistido
  $.ajax({
    url: '/getProgresso', // Rota para buscar o progresso
    method: 'GET',
    data: { usuarioId: usuarioId, cursoId: 1 },
    success: function(response) {
      const videosJaAssistidos = response.videosJaAssistidos || []; // Lista de vídeos já assistidos

      // Verifica se o vídeo atual já foi assistido
      if (videosJaAssistidos.includes(videoIdAtual)) {
        console.log('O vídeo já foi assistido. Nenhuma atualização será feita.');
        return;  // Interrompe o processo aqui se o vídeo já foi assistido
      }

      // Se o vídeo não foi assistido, incrementar o progresso
      const videosAssistidos = response.videosAssistidos || 0;

      if (videosAssistidos < 3) {
        // Incrementar o número de vídeos assistidos
        const novoProgresso = videosAssistidos + 1;

        // Salvar o novo progresso no banco de dados
        salvarProgresso(novoProgresso, 3, videoIdAtual); // Inclui o vídeo atual
      } else {
        console.log('Todos os vídeos já foram assistidos.');
      }
    },
    error: function(xhr, status, error) {
      console.error('Erro ao buscar progresso:', error);
    }
  });
}

// Função para salvar o progresso e o vídeo atual no banco de dados
function salvarProgresso(videosAssistidos, totalVideos, videoIdAtual) {
  if (!usuarioId) {
    console.error('ID do usuário não foi obtido ainda!');
    return;
  }

  const cursoId = 1; // ID do curso

  const data = {
    usuarioId: usuarioId,
    cursoId: cursoId,
    videosAssistidos: videosAssistidos,
    totalVideos: totalVideos,
    videoIdAtual: videoIdAtual // Salvar o ID do vídeo assistido
  };

  // Envia o progresso atualizado para o backend
  $.ajax({
    url: '/salvarProgresso',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data),
    success: function(response) {
      console.log('Progresso salvo com sucesso!', response);

      // Atualiza a barra de progresso visualmente apenas se o progresso foi salvo corretamente
      const progresso = Math.min((videosAssistidos / totalVideos) * 100, 100);

      // Atualiza a barra de progresso visualmente
      atualizarBarraProgresso(progresso);
    },
    error: function(xhr, status, error) {
      console.error('Erro ao salvar progresso:', error);
    }
  });
}

// Função para atualizar a barra de progresso
function atualizarBarraProgresso(progresso) {
  const progressBar = document.getElementById('progress-bar');
  const progressoLimitado = Math.min(progresso, 100); // Limita o progresso a 100%
  progressBar.style.width = `${progressoLimitado}%`; // Define a largura em porcentagem
  progressBar.innerText = `${progressoLimitado.toFixed(0)}%`; // Atualiza o texto da barra
  console.log('Barra de progresso atualizada para:', progressoLimitado + '%');
}

// Chamar a função de obtenção do ID do usuário assim que a página carregar
$(document).ready(function() {
  obterUsuarioId().then(function() {
    // Fazer requisição para buscar o progresso do curso
    $.ajax({
      url: '/getProgresso',
      method: 'GET',
      data: { usuarioId: usuarioId, cursoId: 1 },
      success: function(response) {
        const progresso = Math.min((response.videosAssistidos / 3) * 100, 100); // Exemplo com 3 vídeos
        console.log('Progresso recuperado:', progresso); // Verificar o progresso recuperado
        atualizarBarraProgresso(progresso); // Atualiza a barra de progresso
      },
      error: function(xhr, status, error) {
        console.error('Erro ao buscar progresso:', error);
      }
    });
  });
});

$(document).ready(function() {
    // Selecionar todas as estrelas
    const stars = document.querySelectorAll('.star');
    const ratingValueDisplay = document.getElementById('ratingValueDisplay');
    let rating = 0; // Inicializar a variável rating

    // Adicionar eventos às estrelas
    stars.forEach(star => {
        star.addEventListener('click', function() {
            rating = this.getAttribute('data-value');
            updateStars(rating);
            //ratingValueDisplay.textContent = `Avaliação: ${rating} estrelas`;

            // Enviar a avaliação ao servidor
            salvarAvaliacao(rating);
        });

        star.addEventListener('mouseover', function() {
            updateStars(this.getAttribute('data-value'));
        });

        star.addEventListener('mouseout', function() {
            updateStars(rating);
        });
    });

    // Função para salvar a avaliação no banco de dados
    function salvarAvaliacao(rating) {
        if (!usuarioId) {
            console.error('ID do usuário não foi obtido ainda!');
            return;
        }

        const cursoId = 1; // ID do curso

        // Dados a serem enviados
        const data = {
            usuarioId: usuarioId,
            cursoId: cursoId,
            avaliacao: rating
        };

        // Requisição Ajax para enviar a avaliação ao backend
        $.ajax({
            url: '/salvarAvaliacao', // Rota para salvar a avaliação
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                console.log('Avaliação salva com sucesso!', response);
            },
            error: function(xhr, status, error) {
                console.error('Erro ao salvar avaliação:', error);
            }
        });
    }

    // Função para buscar a avaliação do usuário
    function buscarAvaliacao() {
        if (!usuarioId) {
            console.error('ID do usuário não foi obtido ainda!');
            return;
        }

        const cursoId = 1; // ID do curso

        // Requisição Ajax para buscar a avaliação do usuário
        $.ajax({
            url: '/getAvaliacao', // Rota para buscar a avaliação
            method: 'GET',
            data: { usuarioId: usuarioId, cursoId: cursoId },
            success: function(response) {
                if (response.avaliacao) {
                    const avaliacao = response.avaliacao;
                    updateStars(avaliacao); // Atualiza as estrelas visualmente
                    //ratingValueDisplay.textContent = `Avaliação: ${avaliacao} estrelas`; // Mostra a avaliação
                    rating = avaliacao; // Atualiza a variável `rating` com a avaliação recuperada
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar avaliação:', error);
            }
        });
    }

    // Chama a função de obtenção do ID do usuário ao carregar a página
    obterUsuarioId().then(function() {
        // Após obter o ID do usuário, buscar a avaliação dele
        buscarAvaliacao();
    });
    
    // Função para atualizar as estrelas visualmente
    function updateStars(rating) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('selected');
            } else {
                star.classList.remove('selected');
            }
        });
    }
});

  </script>
</body>

</html>
