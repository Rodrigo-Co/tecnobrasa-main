<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word</title>
  <link rel="stylesheet" href="/pagvideos.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
</head>
<body>
  <div id="sidebar" class="sidebar">
    <h2>TECNOBRASA</h2>
    <div id="linha"></div>
    <ul>
      <li><a href="/pagaluno.html">Cursos</a></li>
      <li><a href="#">Questões</a></li>
      <li><a href="/indexInicio.html">Sair</a></li>
    </ul>
  </div>

  <div id="content">
    <div id="boxmenu">
      <img src="/barras.png" id="menu-toggle">
      <h2>Meus Cursos</h2>
    </div>

    <div class="progress" role="progressbar" aria-label="Warning" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      <div class="progress-bar text-bg-warning" style="width: 0%">0%</div>
    </div>

    <div id="Container" class="container-fluid">
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action" aria-current="true" onclick="openOverlay('videoOverlay', getCursoIdFromURL())">
          <div class="d-flex align-items-center">
            <div id="icon" style="margin-right: 15px;">
              <img src="#" alt="Word Básico" style="width: 70px; height: 70px; border-radius: 50%;">
            </div>
            <div class="w-100">
              <div class="d-flex justify-content-between">
                <h5 class="mb-1">Excel Office Básico</h5>
                <small>10 minutos</small>
              </div>
              <p class="mb-1">Aula voltada para iniciantes.</p>
              <small style="position: relative; right: 0;">Anna Victoria</small>
            </div>
          </div>
        </a>
        <a href="#" class="list-group-item list-group-item-action" onclick="openOverlay('videoOverlay2', getCursoIdFromURL())">
          <div class="d-flex align-items-center">
            <div id="icon" style="margin-right: 15px;">
              <img src="#" alt="Word Intermediário" style="width: 70px; height: 70px; border-radius: 50%;">
            </div>
            <div class="w-100">
              <div class="d-flex justify-content-between">
                <h5 class="mb-1">Excel Office Intermediário</h5>
                <small>20 minutos</small>
              </div>
              <p class="mb-1">Aula voltada para revisão geral.</p>
              <small style="position: relative; right: 0;">Anna Victoria</small>
            </div>
          </div>
        </a>
        <a href="#" class="list-group-item list-group-item-action" onclick="openOverlay('videoOverlay3', getCursoIdFromURL())">
          <div class="d-flex align-items-center">
            <div id="icon" style="margin-right: 15px;">
              <img src="#" alt="Word Avançado" style="width: 70px; height: 70px; border-radius: 50%;">
            </div>
            <div class="w-100">
              <div class="d-flex justify-content-between">
                <h5 class="mb-1">Excel Office Avançado</h5>
                <small>30 minutos</small>
              </div>
              <p class="mb-1">Aula voltada para aplicação de fórmulas.</p>
              <small style="position: relative; right: 0;">Anna Victoria</small>
            </div>
          </div>
        </a>
      </div>
    </div>

    <!-- Overlays dos vídeos -->
    <div id="videoOverlay" class="overlay">
      <div class="overlay-content" style="display: flex; align-items: flex-start;">
        <span class="close" onclick="closeOverlay('videoOverlay')" style="position: absolute; top: 10px; right: 10px; cursor: pointer;">&times;</span>
        <video width="1280" height="720" controls style="margin-top: 50px;">
          <source src="/video/video-test.mp4" type="video/mp4">
          Seu navegador não suporta o elemento de vídeo.
        </video>
        <div style="margin-left: 20px;">
          <h3>Word Office Básico</h3>
          <textarea id="videoNotes" rows="30" cols="50" placeholder="Escreva suas anotações aqui..." style="margin-top: 10px;"></textarea>
        </div>
      </div>
    </div>

    <div id="videoOverlay2" class="overlay">
      <div class="overlay-content" style="display: flex; align-items: flex-start;">
        <span class="close" onclick="closeOverlay('videoOverlay2')" style="position: absolute; top: 10px; right: 10px; cursor: pointer;">&times;</span>
        <video width="1280" height="720" controls style="margin-top: 50px;">
          <source src="/video/video-test.mp4" type="video/mp4">
          Seu navegador não suporta o elemento de vídeo.
        </video>
        <div style="margin-left: 20px;">
          <h3>Word Office Intermediário</h3>
          <textarea id="videoNotes" rows="30" cols="50" placeholder="Escreva suas anotações aqui..." style="margin-top: 10px;"></textarea>
        </div>
      </div>
    </div>

    <div id="videoOverlay3" class="overlay">
      <div class="overlay-content" style="display: flex; align-items: flex-start;">
        <span class="close" onclick="closeOverlay('videoOverlay3')" style="position: absolute; top: 10px; right: 10px; cursor: pointer;">&times;</span>
        <video width="1280" height="720" controls style="margin-top: 50px;">
          <source src="/video/video-test.mp4" type="video/mp4">
          Seu navegador não suporta o elemento de vídeo.
        </video>
        <div style="margin-left: 20px;">
          <h3>Word Office Avançado</h3>
          <textarea id="videoNotes" rows="30" cols="50" placeholder="Escreva suas anotações aqui..." style="margin-top: 10px;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
  <script src='https://cdn.jsdelivr.net/jquery.mixitup/latest/jquery.mixitup.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let usuarioId;
    let cursoId;
    const totalVideos = 3;
    let videosAssistidos = 0;
    let videosJaAssistidos = [];

    function getCursoIdFromURL() {
      const cursoId = new URLSearchParams(window.location.search).get('cursoId');
      console.log('Curso ID obtido da URL:', cursoId); // Debugging
      return cursoId;
    }

    function fetchUsuarioId() {
      return fetch('/getUsuarioId')
        .then(response => {
          if (!response.ok) {
            throw new Error('Usuário não logado');
          }
          return response.json();
        })
        .then(data => {
          usuarioId = data.usuarioId;
          cursoId = getCursoIdFromURL();
          console.log('Usuario ID:', usuarioId); // Debugging
          console.log('Curso ID:', cursoId); // Debugging
          return fetchProgresso();
        })
        .catch(error => {
          console.error('Erro ao buscar o ID do usuário:', error);
        });
    }

    function fetchProgresso() {
      if (!usuarioId || !cursoId) {
        console.error('Usuário ou curso não logado.');
        return;
      }

      return fetch(`/getProgresso?usuarioId=${usuarioId}&cursoId=${cursoId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro ao buscar o progresso');
          }
          return response.json();
        })
        .then(data => {
          if (data.videosAssistidos !== undefined) {
            videosAssistidos = data.videosAssistidos;
            videosJaAssistidos = data.videosAssistidosIds || [];
            const novaLargura = (videosAssistidos / totalVideos) * 100;
            document.querySelector('.progress-bar').style.width = novaLargura + '%';
            document.querySelector('.progress-bar').textContent = Math.round(novaLargura) + '%';
          }
        })
        .catch(error => {
          console.error('Erro ao carregar o progresso:', error);
        });
    }

    function openOverlay(overlayId, cursoId) {
      if (!usuarioId || !cursoId) {
        console.error('Usuário não logado ou cursoId não disponível.');
        return;
      }

      if (!videosJaAssistidos.includes(overlayId)) {
        videosJaAssistidos.push(overlayId);
        videosAssistidos = Math.min(videosAssistidos + 1, totalVideos);
        const novaLargura = (videosAssistidos / totalVideos) * 100;
        document.querySelector('.progress-bar').style.width = novaLargura + '%';
        document.querySelector('.progress-bar').textContent = Math.round(novaLargura) + '%';

        const progressoData = {
          usuarioId: usuarioId,
          cursoId: cursoId,
          videosAssistidos: videosAssistidos,
          totalVideos: totalVideos
        };

        fetch('/salvarProgresso', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(progressoData)
        })
        .then(response => response.json())
        .then(data => {
          console.log(data.message);
        })
        .catch(error => {
          console.error('Erro ao salvar o progresso:', error);
        });
      }

      document.getElementById(overlayId).style.display = "flex";
    }

    function closeOverlay(overlayId) {
      document.getElementById(overlayId).style.display = "none";
    }

    $('#menu-toggle').on('click', function () {
      $('#sidebar').toggleClass('active');
      $('#content').toggleClass('shifted');
    });

    window.onload = function() {
      fetchUsuarioId();
    };
  </script>
</body>
</html>
